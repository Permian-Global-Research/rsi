<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rsi">
<title>Downloading data from STAC APIs using rsi • rsi</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Libre_Franklin-0.4.9/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Downloading data from STAC APIs using rsi">
<meta property="og:description" content="rsi">
<meta property="og:image" content="https://permian-global-research.github.io/rsi/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rsi</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.2.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/rsi.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Downloading-data-from-STAC-APIs-using-rsi.html">Downloading data from STAC APIs using rsi</a>
    <a class="dropdown-item" href="../articles/How-can-I-.html">How can I...?</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Permian-Global-Research/rsi/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Downloading data from STAC APIs using rsi</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Permian-Global-Research/rsi/blob/HEAD/vignettes/articles/Downloading-data-from-STAC-APIs-using-rsi.Rmd" class="external-link"><code>vignettes/articles/Downloading-data-from-STAC-APIs-using-rsi.Rmd</code></a></small>
      <div class="d-none name"><code>Downloading-data-from-STAC-APIs-using-rsi.Rmd</code></div>
    </div>

    
    
<p>This article walks through downloading data from STAC APIs using rsi,
as well as using CQL2 to run more complicated queries. These tutorials
are directly adapted from the <a href="https://stacspec.org/en/tutorials/1-download-data-using-r/" class="external-link">downloading
data</a> and <a href="https://stacspec.org/en/tutorials/2-using-rstac-and-cql2-to-query-stac-api/" class="external-link">using
CQL2</a> tutorials on the STAC website, originally written by Mike
Mahoney and licensed <a href="https://creativecommons.org/licenses/by/4.0/" class="external-link">CC-BY 4.0</a>. This
tutorial assumes you’re already pretty familiar with working with
spatial data in R.</p>
<p>To get started, we’ll go ahead and load rsi, which we’ll be using to
download our data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Permian-Global-Research/rsi" class="external-link">rsi</a></span><span class="op">)</span></span></code></pre></div>
<p>We’ll also be using sf, to specify our spatial area of interest;
terra, to visualize our downloaded data; and rstac, to show how STAC
objects are generally organized. We aren’t going to attach any of these,
in order to make it clear what functions are coming from rsi itself.
They should all be installed as part of installing rsi, so you shouldn’t
need to install anything new for this tutorial.</p>
<div class="section level2">
<h2 id="an-overview-of-stac-itself">An overview of STAC itself<a class="anchor" aria-label="anchor" href="#an-overview-of-stac-itself"></a>
</h2>
<p>You can safely skip this section if you’re familiar with STAC and
rstac.</p>
<p>Before we start downloading data, let’s talk a little bit about STAC.
STAC is, to <a href="https://github.com/radiantearth/stac-spec" class="external-link">quote
the project’s main repository</a>, “a family of specifications aim to
standardize the way geospatial asset metadata is structured and
queried”. STAC provides a useful set of standardized metadata fields,
and standardized ways of organizing and distributing data products,
which make it a lot easier for data producers to document and share
their data, and for data consumers to discover, query, access, and
harmonize available products.</p>
<p>There’s some amount of unavoidable complexity that you need to push
through before it actually <em>feels</em> easier, though. STAC
introduces a number of new object types, each of which have their own
standardized metadata fields and behaviors. The actual geospatial data
you want to access is called an <em>asset</em>. Multiple assets which
share metadata – in particular, which share a spatiotemporal extent –
may be grouped into a STAC <em>item</em>, and multiple items which share
metadata may be grouped into a STAC <em>collection</em>. STAC APIs then
expose these objects to the internet, and let users explore them via
HTTP requests.</p>
<p>To give a more concrete example: the red band of a single Landsat
image would be a STAC asset. It would be combined with all the other
bands acquired from that same image into a STAC item, which would then
be combined with all other available Landsat images into a STAC
collection. If this collection was then included in a STAC API, you
could send a request to list all the available collections, to list all
the items included in the Landsat collection, or to list all the assets
available in a given item. You could also narrow down the results of
these requests using queries – listing only the items inside a given
spatiotemporal bounding box, or under a certain cloud cover threshold,
for instance.</p>
<p>This explanation is a very simplified overview of the STAC family of
standards – for instance, items may also be grouped into
<em>catalogs</em>, and collections and catalogs may themselves be
grouped into other collections and catalogs. For all practical purposes
however, if your main interest is downloading data from STAC APIs, the
simplified explanation is pretty decent.</p>
<p>For instance, we can see this organization in the wild by using rstac
to explore a public STAC API. Microsoft hosts a STAC API as part of
their <a href="https://planetarycomputer.microsoft.com/" class="external-link">Planetary
Computer</a>; we’ll use their API for the rest of this tutorial.</p>
<p>To start downloading data, we’ll first need to let rstac know what
STAC API we want to query and download from. To do so, we’ll pass the
URL of the Planetary Computer STAC API to the <code><a href="https://brazil-data-cube.github.io/rstac/reference/stac.html" class="external-link">rstac::stac()</a></code>
function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stac_source</span> <span class="op">&lt;-</span> <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/stac.html" class="external-link">stac</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://planetarycomputer.microsoft.com/api/stac/v1"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">stac_source</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">###rstac_query</span></span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">url:</span> https://planetarycomputer.microsoft.com/api/stac/v1/</span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">params:</span></span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">field(s):</span> version, base_url, endpoint, params, verb, encode</span></span></code></pre></div>
<p>As you can see, the output of <code>stac()</code> is an
<code>RSTACQuery</code> object, which contains information about an HTTP
query. Specifically, it’s worth highlighting that this object is a
representation of a <em>future</em> HTTP query, not the results of one
that we’ve already run! In order to actually execute these requests, we
need to use <code><a href="https://brazil-data-cube.github.io/rstac/reference/request.html" class="external-link">rstac::get_request()</a></code> (or
<code><a href="https://brazil-data-cube.github.io/rstac/reference/request.html" class="external-link">rstac::post_request()</a></code>, depending on what HTTP verb your
STAC API is expecting). If we use <code>get_request()</code> to query
the Planetary Computer STAC API, we get a brief description of what this
API provides:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/request.html" class="external-link">get_request</a></span><span class="op">(</span><span class="va">stac_source</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">###Catalog</span></span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">id:</span> microsoft-pc</span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">description:</span> </span></span>
<span><span class="co">#&gt; Searchable spatiotemporal metadata describing Earth science datasets hosted by the Microsoft Planetary Computer</span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">field(s):</span> </span></span>
<span><span class="co">#&gt; type, id, title, description, stac_version, conformsTo, links, stac_extensions</span></span></code></pre></div>
<p>Because the <code>RSTACQuery</code> object is a representation of a
future query, we can use other functions in rstac to change our query
parameters and fields before we actually make a request. For instance,
we can use <code><a href="https://brazil-data-cube.github.io/rstac/reference/collections.html" class="external-link">rstac::collections()</a></code> to update our request to
query the <code>/collections</code> endpoint of the Planetary Computer
API, which lists all the collections available from this API:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stac_source</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/collections.html" class="external-link">collections</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/request.html" class="external-link">get_request</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">###Collections</span></span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">collections</span> (123 item(s)):</span></span>
<span><span class="co">#&gt;   - daymet-annual-pr</span></span>
<span><span class="co">#&gt;   - daymet-daily-hi</span></span>
<span><span class="co">#&gt;   - 3dep-seamless</span></span>
<span><span class="co">#&gt;   - 3dep-lidar-dsm</span></span>
<span><span class="co">#&gt;   - fia</span></span>
<span><span class="co">#&gt;   - sentinel-1-rtc</span></span>
<span><span class="co">#&gt;   - gridmet</span></span>
<span><span class="co">#&gt;   - daymet-annual-na</span></span>
<span><span class="co">#&gt;   - daymet-monthly-na</span></span>
<span><span class="co">#&gt;   - daymet-annual-hi</span></span>
<span><span class="co">#&gt;   - ... with 113 more collection(s).</span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">field(s):</span> collections, links</span></span></code></pre></div>
<p>These collections are a subset of the data sets available in the <a href="https://planetarycomputer.microsoft.com/catalog" class="external-link">Planetary
Computer data catalog</a>; the Planetary Computer is organized so that
each collection corresponds to a distinct data set in the catalog.</p>
<p>For our purposes today, we’re going to be querying two different
collections: first, the <a href="https://planetarycomputer.microsoft.com/dataset/usgs-lcmap-conus-v13" class="external-link">USGS
Land Change Monitoring, Assessment, and Projection (LCMAP)</a>
collection, which provides (among other things) annual land cover
classifications for the continental United States, and secondly the <a href="https://planetarycomputer.microsoft.com/dataset/landsat-c2-l2" class="external-link">Landsat
Collection 2 Level-2</a> collection, which provides global satellite
imagery.</p>
<p>We can query what items are available for either collection using the
<code><a href="https://brazil-data-cube.github.io/rstac/reference/stac_search.html" class="external-link">rstac::stac_search()</a></code> function. We can limit our search to
2021 using the <code>datetime</code> argument, ask for up to 999 items
(the most Planetary Computer will return in a single request) using the
<code>limit</code> argument, and only search within the LCMAP collection
by using the collection’s ID of <code>usgs-lcmap-conus-v13</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/stac_search.html" class="external-link">stac_search</a></span><span class="op">(</span></span>
<span>  q <span class="op">=</span> <span class="va">stac_source</span>,</span>
<span>  collections <span class="op">=</span> <span class="st">"usgs-lcmap-conus-v13"</span>,</span>
<span>  datetime <span class="op">=</span> <span class="st">"2021-01-01/2021-12-31"</span>,</span>
<span>  limit <span class="op">=</span> <span class="fl">999</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/request.html" class="external-link">get_request</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">###Items</span></span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">features</span> (422 item(s)):</span></span>
<span><span class="co">#&gt;   - LCMAP_CU_032003_2021_V13_CCDC</span></span>
<span><span class="co">#&gt;   - LCMAP_CU_031006_2021_V13_CCDC</span></span>
<span><span class="co">#&gt;   - LCMAP_CU_031004_2021_V13_CCDC</span></span>
<span><span class="co">#&gt;   - LCMAP_CU_031003_2021_V13_CCDC</span></span>
<span><span class="co">#&gt;   - LCMAP_CU_031002_2021_V13_CCDC</span></span>
<span><span class="co">#&gt;   - LCMAP_CU_030007_2021_V13_CCDC</span></span>
<span><span class="co">#&gt;   - LCMAP_CU_030006_2021_V13_CCDC</span></span>
<span><span class="co">#&gt;   - LCMAP_CU_030005_2021_V13_CCDC</span></span>
<span><span class="co">#&gt;   - LCMAP_CU_030004_2021_V13_CCDC</span></span>
<span><span class="co">#&gt;   - LCMAP_CU_030003_2021_V13_CCDC</span></span>
<span><span class="co">#&gt;   - ... with 412 more feature(s).</span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">assets:</span> </span></span>
<span><span class="co">#&gt; browse, dates, lcachg, lcachg_metadata, lcpconf, lcpconf_metadata, lcpri, lcpri_metadata, lcsconf, lcsconf_metadata, lcsec, lcsec_metadata, rendered_preview, sclast, sclast_metadata, scmag, scmag_metadata, scmqa, scmqa_metadata, scstab, scstab_metadata, sctime, sctime_metadata, tilejson</span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">item's fields:</span> </span></span>
<span><span class="co">#&gt; assets, bbox, collection, geometry, id, links, properties, stac_extensions, stac_version, type</span></span></code></pre></div>
<p>We can see that there are 422 items inside this catalog for 2021.
Collectively, these items contain all LCMAP data for the continental
United States for 2021, with each item containing a number of assets.
We’ll be specifically downloading the <code>lcpri</code> and
<code>lcsec</code> assets in a minute – the primary and secondary land
cover classification layers of these data products.</p>
<p>To query the Landsat archives, we’d just swap out our collections
argument. I’m also going to drop the <code>limit</code> argument here –
there are way, way more than 1,000 Landsat images from 2021, and we
don’t need a full list of them right now:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/stac_search.html" class="external-link">stac_search</a></span><span class="op">(</span></span>
<span>  q <span class="op">=</span> <span class="va">stac_source</span>,</span>
<span>  collections <span class="op">=</span> <span class="st">"landsat-c2-l2"</span>,</span>
<span>  datetime <span class="op">=</span> <span class="st">"2021-01-01/2021-12-31"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/request.html" class="external-link">get_request</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">###Items</span></span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">features</span> (250 item(s)):</span></span>
<span><span class="co">#&gt;   - LC09_L2SR_088122_20211230_02_T2</span></span>
<span><span class="co">#&gt;   - LC09_L2SR_088121_20211230_02_T2</span></span>
<span><span class="co">#&gt;   - LC09_L2SR_088120_20211230_02_T2</span></span>
<span><span class="co">#&gt;   - LC09_L2SR_088119_20211230_02_T2</span></span>
<span><span class="co">#&gt;   - LC09_L2SR_088118_20211230_02_T2</span></span>
<span><span class="co">#&gt;   - LC09_L2SR_088117_20211230_02_T2</span></span>
<span><span class="co">#&gt;   - LC09_L2SR_088116_20211230_02_T2</span></span>
<span><span class="co">#&gt;   - LC09_L2SR_088115_20211230_02_T2</span></span>
<span><span class="co">#&gt;   - LC09_L2SR_088114_20211230_02_T2</span></span>
<span><span class="co">#&gt;   - LC09_L2SR_088113_20211230_02_T2</span></span>
<span><span class="co">#&gt;   - ... with 240 more feature(s).</span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">assets:</span> </span></span>
<span><span class="co">#&gt; ang, atran, blue, cdist, coastal, drad, emis, emsd, green, lwir11, mtl.json, mtl.txt, mtl.xml, nir08, qa, qa_aerosol, qa_pixel, qa_radsat, red, rendered_preview, swir16, swir22, tilejson, trad, urad</span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">item's fields:</span> </span></span>
<span><span class="co">#&gt; assets, bbox, collection, geometry, id, links, properties, stac_extensions, stac_version, type</span></span></code></pre></div>
<p>If we wanted a full list, we could pipe the outputs of our query
object to <code><a href="https://brazil-data-cube.github.io/rstac/reference/items_functions.html" class="external-link">rstac::items_fetch()</a></code> to iterate through all the
pages of our request. We aren’t going to do that right now – it takes a
long time and we don’t need to – but put a pin in this idea, for
later.</p>
</div>
<div class="section level2">
<h2 id="downloading-data-from-stac-apis-using-rsi">Downloading data from STAC APIs using rsi<a class="anchor" aria-label="anchor" href="#downloading-data-from-stac-apis-using-rsi"></a>
</h2>
<p>It took us a thousand words, but we’ve finally reached the title of
the vignette: how can we actually download data from this API?</p>
<p>We’ll start off downloading data for a relatively small region;
namely, North Carolina’s Ashe County. We’ll use data included in the sf
package to get the county’s geometry:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shape/nc.shp"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ashe</span> <span class="op">&lt;-</span> <span class="va">nc</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">ashe</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-7-1.png" width="768"></p>
<p>And… that’s all the prep we need. We can go ahead and use this object
with the <code><a href="../reference/get_stac_data.html">get_stac_data()</a></code> function from rsi, which takes a
number of arguments to determine <em>which</em> STAC data we’re trying
to get and what exactly we want to do with it. Let’s use it to download
the primary land cover classification asset from LCMAP for this area –
the <code>lcpri</code> asset:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ashe_lcpri</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_stac_data.html">get_stac_data</a></span><span class="op">(</span></span>
<span>  <span class="co"># Spatial AOI:</span></span>
<span>  aoi <span class="op">=</span> <span class="va">ashe</span>,</span>
<span>  <span class="co"># Temporal AOI:</span></span>
<span>  start_date <span class="op">=</span> <span class="st">"2021-01-01"</span>,</span>
<span>  end_date <span class="op">=</span> <span class="st">"2021-12-31"</span>,</span>
<span>  <span class="co"># Which asset do we want, from which collection, from which API:</span></span>
<span>  asset_names <span class="op">=</span> <span class="st">"lcpri"</span>,</span>
<span>  stac_source <span class="op">=</span> <span class="st">"https://planetarycomputer.microsoft.com/api/stac/v1"</span>,</span>
<span>  collection <span class="op">=</span> <span class="st">"usgs-lcmap-conus-v13"</span>,</span>
<span>  <span class="co"># Where to save the file:</span></span>
<span>  output_filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ashe_lcpri</span></span>
<span><span class="co">#&gt; [1] "/tmp/RtmpbAKu4D/file1df3161496ce.tif"</span></span></code></pre></div>
<p>And a few seconds later, we’ve got our data! The output from
<code><a href="../reference/get_stac_data.html">get_stac_data()</a></code> is a path to this data, saved as a raster
somewhere on our computer; that means we can pass this object to
<code><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">terra::rast()</a></code> and <code><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">terra::plot()</a></code> to load this
data into R and visualize it:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">ashe_lcpri</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-9-1.png" width="768"></p>
<p>If we draw our Ashe county polygon on top of this raster, we can see
that <code><a href="../reference/get_stac_data.html">get_stac_data()</a></code> has only downloaded the portion of
this asset that falls within the bounding box we provided:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">ashe_lcpri</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">ashe</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-10-1.png" width="768"></p>
<p>What if we wanted to download more than one raster asset? We could
choose to pass multiple asset names to <code>asset_names</code>. For
instance, if we wanted to also download the secondary land cover
classification for this area (called <code>lcsec</code>), we could
write:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_stac_data.html">get_stac_data</a></span><span class="op">(</span></span>
<span>  aoi <span class="op">=</span> <span class="va">ashe</span>,</span>
<span>  start_date <span class="op">=</span> <span class="st">"2021-01-01"</span>,</span>
<span>  end_date <span class="op">=</span> <span class="st">"2021-12-31"</span>,</span>
<span>  asset_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lcpri"</span>, <span class="st">"lcsec"</span><span class="op">)</span>, <span class="co"># this is the only change!</span></span>
<span>  stac_source <span class="op">=</span> <span class="st">"https://planetarycomputer.microsoft.com/api/stac/v1"</span>,</span>
<span>  collection <span class="op">=</span> <span class="st">"usgs-lcmap-conus-v13"</span>,</span>
<span>  output_filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".tif"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-11-1.png" width="768"></p>
<p>Neat!</p>
<p>Now, as it happens, Ashe county is entirely contained inside a single
LCMAP tile – so it’s returned by our API as a single STAC item. What if
we wanted to download the same asset from a larger area, that included
more than one item? For instance, what if we wanted to download these
assets for all of North Carolina?</p>
<p>To do so, we just need to change our <code>aoi</code> object to our
<code>nc</code> object, specifying the entire state of North Carolina.
Internally, <code><a href="../reference/get_stac_data.html">get_stac_data()</a></code> will handle downloading the
relevant pieces of each object and merging them together:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_stac_data.html">get_stac_data</a></span><span class="op">(</span></span>
<span>  aoi <span class="op">=</span> <span class="va">nc</span>, <span class="co"># this is the only change!</span></span>
<span>  start_date <span class="op">=</span> <span class="st">"2021-01-01"</span>,</span>
<span>  end_date <span class="op">=</span> <span class="st">"2021-12-31"</span>,</span>
<span>  asset_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lcpri"</span>, <span class="st">"lcsec"</span><span class="op">)</span>,</span>
<span>  stac_source <span class="op">=</span> <span class="st">"https://planetarycomputer.microsoft.com/api/stac/v1"</span>,</span>
<span>  collection <span class="op">=</span> <span class="st">"usgs-lcmap-conus-v13"</span>,</span>
<span>  output_filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".tif"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-12-1.png" width="768"></p>
<p>If we wanted, we could parallelize these downloads using
<code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">future::plan()</a></code>, and set up a progress bar using
<code><a href="https://progressr.futureverse.org/reference/handlers.html" class="external-link">progressr::handlers()</a></code>. We won’t use these functions in this
vignette, but they can be extremely useful for speeding up and
monitoring larger downloads.</p>
<p>By default, the merging done by <code><a href="../reference/get_stac_data.html">get_stac_data()</a></code> does not
interpolate between overlapping pixels, and instead simply uses the
value from whichever pixel it processed last. That’s fine here, where
our tiles shouldn’t overlap (and pixel values should be identical if
they do), but probably isn’t ideal if you want to combine images from
multiple time periods into a single composite.</p>
<p>For instance, if we want to download a composite of all the available
Landsat images over Ashe county from a given month, we’d probably want
to calculate the median value of each pixel, instead of simply taking
the last value from each. We could do that by adding
<code>composite_function = "median"</code> to our
<code><a href="../reference/get_stac_data.html">get_stac_data()</a></code> call.</p>
<p>But that said, we’d probably want to do a number of other things,
too. For instance, we probably don’t want to include images of clouds,
or dark shadows, in that composite; we also probably only want images
from some subset of Landsat missions, and to rescale our bands to
retrieve original measurement values, and so on and so forth. This all
sounds really fiddly.</p>
<p>For that reason, rsi provides a function,
<code><a href="../reference/get_stac_data.html">get_landsat_imagery()</a></code>, which wraps
<code><a href="../reference/get_stac_data.html">get_stac_data()</a></code> and sets a number of arguments to helpful
default values. We use the following block of code to see exactly what
defaults have been changed:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the arguments, and default values, from</span></span>
<span><span class="co"># get_stac_data and get_landsat_imagery</span></span>
<span><span class="va">gsd_formals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/formals.html" class="external-link">formals</a></span><span class="op">(</span><span class="va">get_stac_data</span><span class="op">)</span></span>
<span><span class="va">gli_formals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/formals.html" class="external-link">formals</a></span><span class="op">(</span><span class="va">get_landsat_imagery</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Drop empty arguments</span></span>
<span><span class="va">gsd_formals</span> <span class="op">&lt;-</span> <span class="va">gsd_formals</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">gsd_formals</span>, <span class="va">class</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"name"</span><span class="op">]</span></span>
<span><span class="va">gli_formals</span> <span class="op">&lt;-</span> <span class="va">gli_formals</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">gli_formals</span>, <span class="va">class</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"name"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Highlight changed default values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">gli_formals</span>, <span class="va">gsd_formals</span><span class="op">)</span></span>
<span><span class="co">#&gt; $platforms</span></span>
<span><span class="co">#&gt; c("landsat-9", "landsat-8")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pixel_x_size</span></span>
<span><span class="co">#&gt; [1] 30</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $asset_names</span></span>
<span><span class="co">#&gt; rsi::landsat_band_mapping$planetary_computer_v1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $stac_source</span></span>
<span><span class="co">#&gt; attr(asset_names, "stac_source")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $collection</span></span>
<span><span class="co">#&gt; attr(asset_names, "collection_name")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $query_function</span></span>
<span><span class="co">#&gt; attr(asset_names, "query_function")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $download_function</span></span>
<span><span class="co">#&gt; attr(asset_names, "download_function")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sign_function</span></span>
<span><span class="co">#&gt; attr(asset_names, "sign_function")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $mask_band</span></span>
<span><span class="co">#&gt; attr(asset_names, "mask_band")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $mask_function</span></span>
<span><span class="co">#&gt; attr(asset_names, "mask_function")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $composite_function</span></span>
<span><span class="co">#&gt; [1] "median"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $gdal_config_options</span></span>
<span><span class="co">#&gt; c(VSI_CACHE = "TRUE", GDAL_CACHEMAX = "30%", VSI_CACHE_SIZE = "10000000", </span></span>
<span><span class="co">#&gt;     GDAL_HTTP_MULTIPLEX = "YES", GDAL_INGESTED_BYTES_AT_OPEN = "32000", </span></span>
<span><span class="co">#&gt;     GDAL_DISABLE_READDIR_ON_OPEN = "EMPTY_DIR", GDAL_HTTP_VERSION = "2", </span></span>
<span><span class="co">#&gt;     GDAL_HTTP_MERGE_CONSECUTIVE_RANGES = "YES", GDAL_NUM_THREADS = "ALL_CPUS")</span></span></code></pre></div>
<p>Some of these defaults make sense: we can see that our function is
going to be downloading data from Landsat-9 and Landsat-8, at a 30 meter
resolution, and compositing images by calculating the median of each
pixel’s measurements. That’s all well and good.</p>
<p>But some of these defaults are a bit confusing. We’re apparently
setting our <code>asset_names</code> argument to some random object we
haven’t seen before, and then setting our STAC API’s URL, the collection
we’re downloading from, the method we’re using to query the API, and a
few things (including some arguments that look like they control masking
the downloaded image) based on attributes of that object?</p>
<p>Basically, yes. When you load rsi, you also load a handful of “band
mapping” objects, which can be used to control how rsi functions
download and process data. These objects are organized by the collection
of data they correspond to, and contain sub-objects for all of the
different supported STAC APIs that you can use to download this data
from. For instance, the <code>landsat_band_mapping</code> contains
information that rsi can use to download imagery from the Planetary
Computer:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landsat_band_mapping</span></span>
<span><span class="co">#&gt; $planetary_computer_v1</span></span>
<span><span class="co">#&gt; An rsi band mapping object with attributes:</span></span>
<span><span class="co">#&gt; names mask_band mask_function stac_source collection_name query_function download_function sign_function class</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; coastal    blue   green     red   nir08  swir16  swir22    lwir  lwir11 </span></span>
<span><span class="co">#&gt;     "A"     "B"     "G"     "R"     "N"    "S1"    "S2"     "T"    "T1"</span></span></code></pre></div>
<p>While the <code>sentinel2_band_mapping</code> additionally contains
information about how to download data from both versions of the STAC
API provided by Amazon Web Services’ Open Data portal:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sentinel2_band_mapping</span></span>
<span><span class="co">#&gt; $aws_v0</span></span>
<span><span class="co">#&gt; An rsi band mapping object with attributes:</span></span>
<span><span class="co">#&gt; names mask_band mask_function stac_source collection_name query_function class</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   B01   B02   B03   B04   B05   B06   B07   B08   B8A   B09   B11   B12 </span></span>
<span><span class="co">#&gt;   "A"   "B"   "G"   "R" "RE1" "RE2" "RE3"   "N"  "N2"  "WV"  "S1"  "S2" </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $aws_v1</span></span>
<span><span class="co">#&gt; An rsi band mapping object with attributes:</span></span>
<span><span class="co">#&gt; names mask_band mask_function stac_source collection_name query_function download_function class</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     blue  coastal    green      nir    nir08    nir09      red rededge1 </span></span>
<span><span class="co">#&gt;      "B"      "A"      "G"      "N"     "N2"     "WV"      "R"    "RE1" </span></span>
<span><span class="co">#&gt; rededge2 rededge3   swir16   swir22 </span></span>
<span><span class="co">#&gt;    "RE2"    "RE3"     "S1"     "S2" </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $planetary_computer_v1</span></span>
<span><span class="co">#&gt; An rsi band mapping object with attributes:</span></span>
<span><span class="co">#&gt; names mask_band mask_function stac_source collection_name query_function class scl_name download_function sign_function</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   B01   B02   B03   B04   B05   B06   B07   B08   B8A   B09   B11   B12 </span></span>
<span><span class="co">#&gt;   "A"   "B"   "G"   "R" "RE1" "RE2" "RE3"   "N"  "N2"  "WV"  "S1"  "S2"</span></span></code></pre></div>
<p>These objects are called “band mapping” objects because the contents
of the object explain how to map asset names, as understood by a given
STAC API, to <a href="https://github.com/awesome-spectral-indices/awesome-spectral-indices" class="external-link">the
standardized names used by the Awesome Spectral Indices project</a>. But
they contain a good bit of additional information on how to use each
individual STAC API, attached to the list as attributes; these include
the URL for the relevant STAC API, information on how to query the API
and “sign” item URLs for authentication purposes, and (when possible)
information on how to mask low-quality pixels out of each image.</p>
<p>Because all of this endpoint-specific information is attached to each
band mapping object, rsi can understand how to download and mask your
desired product from your desired API based entirely on the
<code>asset_names</code> argument. Changing the <code>asset_names</code>
to a different STAC API’s subobject will automatically update all of the
other arguments as necessary.</p>
<p>So, with that out of the way, let’s actually download and composite
some Landsat imagery. We need to transform our data into a projected
coordinate reference system in order for our compositing to work, and
we’ll just grab imagery from June 2021 in order to reduce the number of
images we need to download. With those changes in mind, our function to
download Landsat imagery looks like this:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">projected_ashe</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">ashe</span>, <span class="fl">6542</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/get_stac_data.html">get_landsat_imagery</a></span><span class="op">(</span></span>
<span>  aoi <span class="op">=</span> <span class="va">projected_ashe</span>,</span>
<span>  start_date <span class="op">=</span> <span class="st">"2021-06-01"</span>,</span>
<span>  end_date <span class="op">=</span> <span class="st">"2021-06-30"</span>,</span>
<span>  output_filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".tif"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-16-1.png" width="768"></p>
<p>You can see transparent parts of each band where pixels in all images
from June were automatically masked out, due to their value in their
corresponding QA band. This behavior happens automatically, controlled
by the <code>mask_band</code> and <code>mask_function</code> attributes
in our band mapping object. The masking here is pretty basic; only
pixels whose <a href="https://d9-wret.s3.us-west-2.amazonaws.com/assets/palladium/production/s3fs-public/media/files/LSDS-1619_Landsat-8-9-C2-L2-ScienceProductGuide-v4.pdf" class="external-link">QA
band indicates that they were “clear with lows set”</a> are accepted,
and all others are masked out:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">landsat_band_mapping</span><span class="op">$</span><span class="va">planetary_computer_v1</span>, <span class="st">"mask_band"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "qa_pixel"</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">landsat_band_mapping</span><span class="op">$</span><span class="va">planetary_computer_v1</span>, <span class="st">"mask_function"</span><span class="op">)</span></span>
<span><span class="co">#&gt; function (raster, include = c("land", "water", "both")) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     if (missing(include)) </span></span>
<span><span class="co">#&gt;         include &lt;- include[[1]]</span></span>
<span><span class="co">#&gt;     include &lt;- rlang::arg_match(include, multiple = TRUE)</span></span>
<span><span class="co">#&gt;     classes &lt;- numeric()</span></span>
<span><span class="co">#&gt;     if (any(c("land", "both") %in% include)) </span></span>
<span><span class="co">#&gt;         classes &lt;- c(classes, 21824)</span></span>
<span><span class="co">#&gt;     if (any(c("water", "both") %in% include)) </span></span>
<span><span class="co">#&gt;         classes &lt;- c(classes, 21952)</span></span>
<span><span class="co">#&gt;     terra::`%in%`(raster, classes)</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x56526bac7378&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:rsi&gt;</span></span></code></pre></div>
<p>You can control this behavior by passing your own function to the
<code>mask_function</code> argument, or set this argument to
<code>NULL</code> to skip masking altogether.</p>
<p>If we just wanted a subset of bands in this image, we could subset
the object that’s passed to <code>asset_names</code>. For instance, to
only download the A band (what Planetary Computer calls
<code>coastal</code>), we could subset our object like this:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landsat_band_mapping</span><span class="op">$</span><span class="va">planetary_computer_v1</span><span class="op">[</span><span class="st">"coastal"</span><span class="op">]</span></span>
<span><span class="co">#&gt; An rsi band mapping object with attributes:</span></span>
<span><span class="co">#&gt; mask_band mask_function stac_source collection_name query_function download_function sign_function class names</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; coastal </span></span>
<span><span class="co">#&gt;     "A"</span></span></code></pre></div>
<p>And last but not least, if we wanted to skip compositing altogether,
we could set the <code>composite_function</code> argument to
<code>NULL</code> in order to download each image in our spatiotemporal
AOI separately:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_stac_data.html">get_landsat_imagery</a></span><span class="op">(</span></span>
<span>  aoi <span class="op">=</span> <span class="va">projected_ashe</span>,</span>
<span>  start_date <span class="op">=</span> <span class="st">"2021-06-01"</span>,</span>
<span>  end_date <span class="op">=</span> <span class="st">"2021-06-30"</span>,</span>
<span>  output_filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".tif"</span><span class="op">)</span>,</span>
<span>  composite_function <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  mask_function <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># otherwise half of these images are blank</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="va"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="va"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: `mask_function` was NULL, but `mask_band` was not `NULL`.</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> `mask_band` will be ignored (not downloaded or used).</span></span></code></pre></div>
<p><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-19-1.png" width="768"><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-19-2.png" width="768"><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-19-3.png" width="768"><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-19-4.png" width="768"><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-19-5.png" width="768"><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-19-6.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="using-cql2-to-refine-queries-to-stac-apis">Using CQL2 to refine queries to STAC APIs<a class="anchor" aria-label="anchor" href="#using-cql2-to-refine-queries-to-stac-apis"></a>
</h2>
<p>This last section of the tutorial focuses on using CQL2 within rsi to
filter the items that will be downloaded. If you aren’t familiar with
using CQl2 in rstac, go read <a href="https://github.com/radiantearth/stac-site/blob/main/app/tutorials/r/2-using-rstac-and-cql2-to-query-stac-api/2-using-rstac-and-cql2-to-query-stac-api.en.md" class="external-link">the
corresponding tutorial this is adapted from first</a>; this tutorial
assumes you understand <code><a href="https://brazil-data-cube.github.io/rstac/reference/ext_filter.html" class="external-link">rstac::ext_filter()</a></code> already.</p>
<p>By the end of that tutorial, we had written relatively complex
filters using rstac and CQL2. For instance, if we wanted to find Landsat
images:</p>
<ul>
<li>from June 2021,</li>
<li>covering Ashe county,</li>
<li>from Landsat-8,</li>
<li>with less than 50% cloud cover,</li>
</ul>
<p>We could write a filter that looks something like this:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geometry</span> <span class="op">&lt;-</span> <span class="va">ashe</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/cql2_helpers.html" class="external-link">cql2_bbox_as_geojson</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">datetime</span> <span class="op">&lt;-</span> <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/cql2_helpers.html" class="external-link">cql2_interval</a></span><span class="op">(</span><span class="st">"2021-06-01"</span>, <span class="st">"2021-06-30"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/stac.html" class="external-link">stac</a></span><span class="op">(</span><span class="st">"https://planetarycomputer.microsoft.com/api/stac/v1"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/ext_filter.html" class="external-link">ext_filter</a></span><span class="op">(</span></span>
<span>    <span class="va">collection</span> <span class="op">==</span> <span class="st">"landsat-c2-l2"</span> <span class="op">&amp;&amp;</span></span>
<span>      <span class="fu">t_intersects</span><span class="op">(</span><span class="va">datetime</span>, <span class="op">{</span><span class="op">{</span> <span class="va">datetime</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>      <span class="fu">s_intersects</span><span class="op">(</span><span class="va">geometry</span>, <span class="op">{</span><span class="op">{</span> <span class="va">geometry</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>      <span class="va">platform</span> <span class="op">==</span> <span class="st">"landsat-8"</span> <span class="op">&amp;&amp;</span></span>
<span>      <span class="va">`eo:cloud_cover`</span> <span class="op">&lt;</span> <span class="fl">50</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/request.html" class="external-link">post_request</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">###Items</span></span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">features</span> (1 item(s)):</span></span>
<span><span class="co">#&gt;   - LC08_L2SP_017035_20210628_02_T1</span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">assets:</span> </span></span>
<span><span class="co">#&gt; ang, atran, blue, cdist, coastal, drad, emis, emsd, green, lwir11, mtl.json, mtl.txt, mtl.xml, nir08, qa, qa_aerosol, qa_pixel, qa_radsat, red, rendered_preview, swir16, swir22, tilejson, trad, urad</span></span>
<span><span class="co">#&gt; - <span style="font-weight: bold;">item's fields:</span> </span></span>
<span><span class="co">#&gt; assets, bbox, collection, geometry, id, links, properties, stac_extensions, stac_version, type</span></span></code></pre></div>
<p>How the heck do we use that query inside <code><a href="../reference/get_stac_data.html">get_stac_data()</a></code>
and friends?</p>
<p>Well, by default rsi uses a query function called
<code><a href="../reference/deprecated.html">default_query_function()</a></code>. This function is exported, which
means you can see its source code by calling the function without
parentheses:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">default_query_function</span></span>
<span><span class="co">#&gt; function (bbox, stac_source, collection, start_date, end_date, </span></span>
<span><span class="co">#&gt;     limit, ...) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     lifecycle::deprecate_warn("0.2.0", "default_query_function()", </span></span>
<span><span class="co">#&gt;         "rsi_query_api()")</span></span>
<span><span class="co">#&gt;     rsi_query_api(bbox = bbox, stac_source = stac_source, collection = collection, </span></span>
<span><span class="co">#&gt;         start_date = start_date, end_date = end_date, limit = limit, </span></span>
<span><span class="co">#&gt;         ...)</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x56526de45bb0&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:rsi&gt;</span></span></code></pre></div>
<p>This is a relatively straightforward function – it composes a
datetime from the start date and end date, then uses rstac to get a list
of all the relevant items in its spatiotemporal bounding box (making
sure to use <code>items_fetch()</code> to retrieve all pages of results
– told you it would come up later!).</p>
<p>This works for most STAC APIs, but if we want to perform a more
complicated query we can provide our own custom query function in its
place. For instance, to perform the same CQL2 query as before, we can
effectively copy and paste our code from above into a new query function
and pass that to <code><a href="../reference/get_stac_data.html">get_landsat_imagery()</a></code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_query_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bbox</span>,</span>
<span>                                  <span class="va">stac_source</span>,</span>
<span>                                  <span class="va">collection</span>,</span>
<span>                                  <span class="va">start_date</span>,</span>
<span>                                  <span class="va">end_date</span>,</span>
<span>                                  <span class="va">limit</span>,</span>
<span>                                  <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># `bbox` is guaranteed to be in 4326 already</span></span>
<span>  <span class="va">geometry</span> <span class="op">&lt;-</span> <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/cql2_helpers.html" class="external-link">cql2_bbox_as_geojson</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">)</span></span>
<span>  <span class="co"># `start_date` and `end_date` will be processed</span></span>
<span>  <span class="co"># and so hopefully will be in RFC-3339 formats</span></span>
<span>  <span class="va">datetime</span> <span class="op">&lt;-</span> <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/cql2_helpers.html" class="external-link">cql2_interval</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">request</span> <span class="op">&lt;-</span> <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/ext_filter.html" class="external-link">ext_filter</a></span><span class="op">(</span></span>
<span>    <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/stac.html" class="external-link">stac</a></span><span class="op">(</span><span class="va">stac_source</span><span class="op">)</span>,</span>
<span>    <span class="va">collection</span> <span class="op">==</span> <span class="op">{</span><span class="op">{</span> <span class="va">collection</span> <span class="op">}</span><span class="op">}</span> <span class="op">&amp;&amp;</span> <span class="co"># I could have left this hard-coded!</span></span>
<span>      <span class="fu">t_intersects</span><span class="op">(</span><span class="va">datetime</span>, <span class="op">{</span><span class="op">{</span> <span class="va">datetime</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>      <span class="fu">s_intersects</span><span class="op">(</span><span class="va">geometry</span>, <span class="op">{</span><span class="op">{</span> <span class="va">geometry</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>      <span class="va">platform</span> <span class="op">==</span> <span class="st">"landsat-8"</span> <span class="op">&amp;&amp;</span></span>
<span>      <span class="va">`eo:cloud_cover`</span> <span class="op">&lt;</span> <span class="fl">50</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/items_functions.html" class="external-link">items_fetch</a></span><span class="op">(</span><span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/request.html" class="external-link">post_request</a></span><span class="op">(</span><span class="va">request</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="../reference/get_stac_data.html">get_landsat_imagery</a></span><span class="op">(</span></span>
<span>  aoi <span class="op">=</span> <span class="va">projected_ashe</span>,</span>
<span>  start_date <span class="op">=</span> <span class="st">"2021-06-01"</span>,</span>
<span>  end_date <span class="op">=</span> <span class="st">"2021-06-30"</span>,</span>
<span>  output_filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".tif"</span><span class="op">)</span>,</span>
<span>  query_function <span class="op">=</span> <span class="va">custom_query_function</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Downloading-data-from-STAC-APIs-using-rsi_files/figure-html/unnamed-chunk-22-1.png" width="768"></p>
<p>If we know how to express our desired query in CQL2, we can write
arbitrarily complex functions to make sure we’re only downloading the
precise data we’re interested in.</p>
</div>
<div class="section level2">
<h2 id="a-quick-note-on-rsi-and-other-packages-for-downloading-stac-assets">A quick note on rsi and other packages for downloading STAC
assets<a class="anchor" aria-label="anchor" href="#a-quick-note-on-rsi-and-other-packages-for-downloading-stac-assets"></a>
</h2>
<p>rsi is not nearly the only package aiming to help R users take
advantage of STAC APIs and build cloud-native geospatial workflows. As
shown above, rsi is fundamentally built on top of the excellent rstac
package, which I think is a fantastic tool for interactively exploring
STAC APIs as well as building and executing queries. My hope is that rsi
can provide a useful layer of abstraction over rstac for efficiently
downloading assets and performing some of the most common rescaling,
masking, and compositing tasks involved in standard data processing
workflows.</p>
<p>There are also several other packages which also implement workflows
for efficiently accessing and processing data from STAC endpoints, among
them the <a href="https://gdalcubes.github.io/" class="external-link">gdalcubes</a> and <a href="https://e-sensing.github.io/sitsbook/" class="external-link">sits</a> packages. A core
difference between rsi and these packages is that rsi does not have a
data model: rsi is focused entirely on finding the bits of data you want
from remote endpoints, and getting those bits on your local machine for
you to process with your normal spatial data tooling. There are no new
classes in rsi (other than the band mapping objects), and the outputs of
functions are local rasters. This is an approach that fits better in my
head than the more abstract delayed computations in some other packages;
at the same time, it’s possible that this approach can be less
efficient, downloading more data at finer resolutions than is actually
needed for a given task. As a result, users need to make sure they’re
only requesting data they actually need.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.mm218.dev/" class="external-link">Michael Mahoney</a>, <a href="https://permianglobal.com/" class="external-link"><img src="reference/figures/permian-logo.svg" alt="Permian Global" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
